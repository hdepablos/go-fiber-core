AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Stack principal que orquesta el despliegue de todos los microservicios
  en LocalStack.

  '
Resources:
  GoFiberCoreSqsQueues:
    Type: AWS::Serverless::Application
    Properties:
      Location: GoFiberCoreSqsQueues/template.yaml
    Metadata:
      SamResourceId: GoFiberCoreSqsQueues
  GoFiberCoreSqs:
    Type: AWS::Serverless::Application
    Properties:
      Location: GoFiberCoreSqs/template.yaml
      Parameters:
        SqsQueueArn:
          Fn::ImportValue: SqsQueueArn
        SqsDlqArn:
          Fn::ImportValue: SqsDlqArn
        SqsQueueName:
          Fn::ImportValue: SqsQueueName
    DependsOn: GoFiberCoreSqsQueues
    Metadata:
      SamResourceId: GoFiberCoreSqs
  GoFiberCoreDlq:
    Type: AWS::Serverless::Application
    Properties:
      Location: GoFiberCoreDlq/template.yaml
      Parameters:
        SqsDlqArn:
          Fn::ImportValue: SqsDlqArn
    DependsOn: GoFiberCoreSqsQueues
    Metadata:
      SamResourceId: GoFiberCoreDlq
  GoFiberCoreApi:
    Type: AWS::Serverless::Application
    Properties:
      Location: GoFiberCoreApi/template.yaml
      Parameters:
        SqsQueueUrl:
          Fn::Sub: http://localhost:4566/000000000000/${GoFiberCoreSqsQueues.Outputs.SqsQueueName}
        SqsQueueName:
          Fn::GetAtt:
          - GoFiberCoreSqsQueues
          - Outputs.SqsQueueName
        SqsQueueArn:
          Fn::ImportValue: SqsQueueArn
    DependsOn: GoFiberCoreSqsQueues
    Metadata:
      SamResourceId: GoFiberCoreApi
  GoFiberCoreEvery1minCron:
    Type: AWS::Serverless::Application
    DependsOn: GoFiberCoreSqsQueues
    Properties:
      Location: GoFiberCoreEvery1minCron/template.yaml
    Metadata:
      SamResourceId: GoFiberCoreEvery1minCron
  GoFiberCoreDaily24Cron:
    Type: AWS::Serverless::Application
    Properties:
      Location: GoFiberCoreDaily24Cron/template.yaml
    Metadata:
      SamResourceId: GoFiberCoreDaily24Cron
Outputs:
  ApiUrl:
    Description: URL de la API Gateway
    Value:
      Fn::GetAtt:
      - GoFiberCoreApi
      - Outputs.ApiUrl
  SqsQueueUrlFromExport:
    Description: URL de la cola SQS desde Export
    Value:
      Fn::ImportValue: SqsQueueUrl
  SqsQueueNameFromExport:
    Description: Nombre de la cola SQS desde Export
    Value:
      Fn::ImportValue: SqsQueueName
