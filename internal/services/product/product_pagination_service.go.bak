package product

import (
	"context"
	"go-fiber-core/internal/dtos"
	"go-fiber-core/internal/dtos/connect"
	"go-fiber-core/internal/models"
	"go-fiber-core/internal/repositories/product"
	"gorm.io/gorm"
)

type ProductPaginationService interface {
	GetAllPaginated(ctx context.Context, req dtos.PaginationRequest) (*dtos.PaginationResponse[models.Product], error)
}

type productPaginationService struct {
	conn      *connect.ConnectDTO
	paginator product.ProductPagination
}

func NewProductPaginationService(
	conn *connect.ConnectDTO,
	paginator product.ProductPagination,
) ProductPaginationService {
	return &productPaginationService{
		conn:      conn,
		paginator: paginator,
	}
}
func (s *productPaginationService) GetAllPaginated(ctx context.Context, req dtos.PaginationRequest) (*dtos.PaginationResponse[models.Product], error) {

	// --- 1. Define la función que calcula los extras ---
	extrasCalc := func(query *gorm.DB) (map[string]any, error) {

		var (
			totalProducts        int64
			totalActiveRecords   int64
			totalInactiveRecords int64
			totalPrices          float64
			totalPricesActive    float64
			totalPricesInactive  float64
		)

		// --- Total de productos (sin importar si están activos o no) ---
		if err := query.Session(&gorm.Session{}).
			Model(&models.Product{}).
			Count(&totalProducts).Error; err != nil {
			return nil, err
		}

		// --- Total general de precios ---
		if err := query.Session(&gorm.Session{}).
			Model(&models.Product{}).
			Select("COALESCE(SUM(price), 0)").
			Scan(&totalPrices).Error; err != nil {
			return nil, err
		}

		// --- Activos: conteo y suma de precios ---
		queryActivos := query.Session(&gorm.Session{}).
			Model(&models.Product{}).
			Where("is_active = ?", true)

		if err := queryActivos.Count(&totalActiveRecords).Error; err != nil {
			return nil, err
		}
		if err := queryActivos.Select("COALESCE(SUM(price), 0)").Scan(&totalPricesActive).Error; err != nil {
			return nil, err
		}

		// --- Inactivos: conteo y suma de precios ---
		queryInactivos := query.Session(&gorm.Session{}).
			Model(&models.Product{}).
			Where("is_active = ?", false)

		if err := queryInactivos.Count(&totalInactiveRecords).Error; err != nil {
			return nil, err
		}
		if err := queryInactivos.Select("COALESCE(SUM(price), 0)").Scan(&totalPricesInactive).Error; err != nil {
			return nil, err
		}

		// --- Devolvemos los extras ---
		return map[string]any{
			"total_products":         totalProducts,
			"total_records_active":   totalActiveRecords,
			"total_records_inactive": totalInactiveRecords,
			"total_prices":           totalPrices,
			"total_prices_active":    totalPricesActive,
			"total_prices_inactive":  totalPricesInactive,
		}, nil
	}

	// --- 2. Llamamos al paginador ---
	return s.paginator.GetAllPaginated(
		ctx,
		s.conn.ConnectGormRead,
		req,
		extrasCalc,
	)
}
