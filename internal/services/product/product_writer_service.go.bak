// internal/services/product/product_writer_service.go
package product

import (
	"context"
	"go-fiber-core/internal/dtos/connect"
	"go-fiber-core/internal/models"
	productRepo "go-fiber-core/internal/repositories/product"
)

type ProductWriterService interface {
	Create(ctx context.Context, product *models.Product) error
	CreateBulk(ctx context.Context, products []models.Product) error
	BulkInsertProducts(ctx context.Context, products []models.Product) error
	Update(ctx context.Context, id uint, updatedProductData *models.Product) (*models.Product, error)
	SoftDelete(ctx context.Context, id uint) error
	HardDelete(ctx context.Context, id uint) error
}

type productWriterService struct {
	conn          *connect.ConnectDTO
	productWriter productRepo.ProductWriter
	productReader productRepo.ProductReader
}

func NewProductWriterService(
	conn *connect.ConnectDTO,
	writer productRepo.ProductWriter,
) ProductWriterService {
	return &productWriterService{
		conn:          conn,
		productWriter: writer,
	}
}

func (s *productWriterService) Create(ctx context.Context, product *models.Product) error {
	return s.productWriter.Create(ctx, s.conn.ConnectGormWrite, product)
}

func (s *productWriterService) Update(ctx context.Context, id uint, updatedProductData *models.Product) (*models.Product, error) {
	existingProduct, err := s.productReader.GetByID(ctx, s.conn.ConnectGormWrite, id)
	if err != nil {
		return nil, err
	}

	existingProduct.Name = updatedProductData.Name
	existingProduct.Price = updatedProductData.Price
	existingProduct.Bank = updatedProductData.Bank
	existingProduct.BankID = updatedProductData.BankID
	existingProduct.User = updatedProductData.User
	existingProduct.UserID = updatedProductData.UserID

	if err := s.productWriter.Update(ctx, s.conn.ConnectGormWrite, existingProduct); err != nil {
		return nil, err
	}
	return existingProduct, nil
}

func (s *productWriterService) SoftDelete(ctx context.Context, id uint) error {
	return s.productWriter.SoftDelete(ctx, s.conn.ConnectGormWrite, id)
}

func (s *productWriterService) HardDelete(ctx context.Context, id uint) error {
	return s.productWriter.HardDelete(ctx, s.conn.ConnectGormWrite, id)
}

// --- Nuevo m√©todo bulk insert ---
func (s *productWriterService) CreateBulk(ctx context.Context, products []models.Product) error {
	if len(products) == 0 {
		return nil
	}
	return s.conn.ConnectGormWrite.WithContext(ctx).Create(&products).Error
}

func (s *productWriterService) BulkInsertProducts(ctx context.Context, products []models.Product) error {
	return s.CreateBulk(ctx, products)
}
